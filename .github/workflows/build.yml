# .github/workflows/build.yml â€” UltraGlitch BitFucker CI Build
name: Build UltraGlitch BitFucker

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure CMake (VS2022 x64)
        run: cmake -S . -B build-win -G "Visual Studio 17 2022" -A x64

      - name: Build Release
        run: cmake --build build-win --config Release

      - name: Collect artefacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist/windows-x86_64
          $base = "build-win/UltraGlitch_artefacts/Release"
          Copy-Item -Recurse "$base/VST3/*" dist/windows-x86_64/
          Copy-Item "$base/Standalone/*.exe" dist/windows-x86_64/

      - name: Verify artefacts
        shell: pwsh
        run: |
          if (!(Test-Path "dist/windows-x86_64/UltraGlitch BitFucker.vst3")) { throw "VST3 missing" }
          if (!(Test-Path "dist/windows-x86_64/UltraGlitch BitFucker.exe")) { throw "Standalone missing" }
          Write-Host "âœ… All Windows artefacts verified"

      - name: Upload Windows artefacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x86_64
          path: dist/windows-x86_64/

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure CMake (Xcode)
        run: cmake -B build -G Xcode

      - name: Build Release
        run: cmake --build build --config Release

      - name: Verify universal binary
        run: |
          lipo -info "build/UltraGlitch_artefacts/Release/AU/UltraGlitch BitFucker.component/Contents/MacOS/UltraGlitch BitFucker"
          lipo -info "build/UltraGlitch_artefacts/Release/VST3/UltraGlitch BitFucker.vst3/Contents/MacOS/UltraGlitch BitFucker"

      - name: Collect artefacts
        run: |
          mkdir -p dist/macos-universal
          cp -R "build/UltraGlitch_artefacts/Release/VST3/UltraGlitch BitFucker.vst3" dist/macos-universal/
          cp -R "build/UltraGlitch_artefacts/Release/AU/UltraGlitch BitFucker.component" dist/macos-universal/
          cp -R "build/UltraGlitch_artefacts/Release/Standalone/UltraGlitch BitFucker.app" dist/macos-universal/

      - name: Upload macOS artefacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal
          path: dist/macos-universal/

  package-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - name: Download Windows artefacts
        uses: actions/download-artifact@v4
        with:
          name: windows-x86_64
          path: dist/windows-x86_64/

      - name: Download macOS artefacts
        uses: actions/download-artifact@v4
        with:
          name: macos-universal
          path: dist/macos-universal/

      - name: Package release zip
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          zip -r "${VERSION}.zip" . \
            -x ".git/*" "build/*" "build-win/*" ".DS_Store" "*.zip"
          echo "ðŸ“¦ Created ${VERSION}.zip"
          ls -lh "${VERSION}.zip"

      - name: Upload release zip
        uses: actions/upload-artifact@v4
        with:
          name: release-zip
          path: "*.zip"
